<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Уведомления</title>
</head>
<body>
    <h1>Уведомления</h1>
    <ul>
        {% for notification in notifications %}
            <li id="notification-{{ notification.id }}">
                <p>{{ notification.message }}</p>
                <p><small>{{ notification.created_at }}</small></p>
                <p>Status: {{ notification.status }}</p>
                {% if notification.status == 'unread' %}
                    <a href="{% url 'mark_as_read' notification.id %}">Mark as read</a>
                {% endif %}
            </li>
        {% endfor %}
    </ul>

    <script>
        const user_id = {{ user_data.id }};
        const url = `ws://192.168.1.10:8000/ws/notifications/${user_id}/`;
        console.log("WebSocket URL:", url);
        const socket = new WebSocket(url);

        // Обработчик ошибок WebSocket
        socket.onerror = function(e) {
            console.error("Ошибка WebSocket:", e);
        };

        // Обработчики событий WebSocket
        socket.onopen = () => {
            console.log("WebSocket connection established");
        };

        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            if (data.type === "notifications") {
                // Обработка новых уведомлений
                console.log("Получены уведомления:", data.notifications);
                updateNotifications(data.notifications); // Обновление интерфейса
            }

            if (data.type === "notification_status_update") {
                // Обработка обновления статуса уведомления
                console.log("Статус уведомления обновлён:", data.notification_id, data.status);
                updateNotificationStatus(data.notification_id, data.status);
            }
        };

        socket.onclose = () => {
            console.log("WebSocket connection closed");
        };

        // Функция для обновления списка уведомлений в интерфейсе
        function updateNotifications(notifications) {
            const ul = document.querySelector('ul');
            notifications.forEach(notification => {
                const li = document.createElement('li');
                li.id = `notification-${notification.id}`;
                li.innerHTML = `
                    <p>${notification.message}</p>
                    <p><small>${notification.created_at}</small></p>
                    <p>Status: ${notification.status}</p>
                    ${notification.status === 'unread' ? `<a href="/mark_as_read/${notification.id}">Mark as read</a>` : ''}
                `;
                ul.appendChild(li);
            });
        }

        // Функция для обновления статуса уведомления в интерфейсе
        function updateNotificationStatus(notification_id, status) {
            const notificationElement = document.getElementById(`notification-${notification_id}`);
            if (notificationElement) {
                const statusElement = notificationElement.querySelector('p:last-of-type');
                statusElement.textContent = `Status: ${status}`;
            }
        }

        // Отправка запроса для получения уведомлений
        function getNotifications() {
            socket.send(JSON.stringify({ "action": "get_notifications" }));
        }

        // Отметить уведомление как прочитанное
        function markNotificationAsRead(notification_id) {
            socket.send(JSON.stringify({ 
                "action": "mark_read", 
                "notification_id": notification_id 
            }));
        }
    </script>
</body>
</html>
